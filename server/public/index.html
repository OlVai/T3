<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commander!</title>

  <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>
 <!-- Tab links -->
<div class="tab">
</div>

<div class="contentDiv">
</div>


<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();

    function addToTab(database, text){
      const tab = document.querySelector(".tab"); 
      var button = document.createElement("button");
      button.className = "tablinks";
      button.onclick = function(event) {
        openCity(event, `${database}`);
      };
      button.textContent = `${text}`;
      tab.appendChild(button);
    }

    function addTabcontent(id){
      const contentDiv = document.querySelector(".contentDiv"); 
      const tabContent = document.createElement("div");
      tabContent.className = "tabcontent";
      tabContent.id = `${id}`;
      contentDiv.appendChild(tabContent);
    }

    socket.on('database_names', (data) => {
      const tab = document.querySelector(".tab"); 
      tab.innerHTML = "";
      data.forEach((element) => {
        addToTab(element, element);
        addTabcontent(element);
      });
      addToTab('addNetwork', '+');
      addTabcontent('addNetwork');
    });
    
    socket.emit('get_databases', ' ');

    function openCity(evt, cityName) {
      // Declare all variables
      var i, tabcontent, tablinks;
    
      // Get all elements with class="tabcontent" and hide them
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
        tabcontent[i].innerHTML = ""; // Clear tab content
      }
    
      // Get all elements with class="tablinks" and remove the class "active"
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
    
      // Show the current tab, and add an "active" class to the button that opened the tab
      document.getElementById(cityName).style.display = "block";
      console.log("Changing to active!")
      evt.currentTarget.className += " active";

      // Send a socket.io request with the message "db_stuff" when pressing the tab button with text "Verkko 1"
      if (cityName === 'db') {
        socket.emit('db_stuff', ' ');
        console.log("Sending!");
      }

      if (cityName === 'addNetwork'){
        socket.emit('add_network_db', 'mynetwork');
        console.log("Add new network request sent!")
      }
    }

    socket.on('message', (data) => {
      // Parse the JSON data
      //console.log(`Parsing: ${data}`)
      const jsonData = JSON.parse(data);

      // Find the current active tab
      const currentTab = document.querySelector(".tabcontent.active");

      // Create a heading for the tab
      const heading = document.createElement("h3");
      heading.textContent = jsonData.title;

      // Append the heading to the current tab
      if (currentTab) {
        console.log("Heading appended!");
        currentTab.appendChild(heading);
      }

      // Create rows and columns for each item in the JSON data
      for (const item of jsonData.items) {
        console.log(`Creating row for: ${item}`)
        const row = document.createElement("div");
        row.className = "row";
        var first = true;
        var second = true;

        for (const key in item) {
          if (item.hasOwnProperty(key)) {
            const column = document.createElement("div");
            if(first) {
              column.className = "column1";
              first = false;
            } else if(second){
              column.className = "column2";
              second = false;
            } else {column.className = "column";}
            column.textContent = item[key];
            row.appendChild(column);
          }
        }

        // Append the row to the current tab
        if (currentTab) {
          currentTab.appendChild(row);
        }
      }

      // Remove the "active" class from all tab links
      const tablinks = document.getElementsByClassName("tablinks");
      for (const tablink of tablinks) {
        tablink.classList.remove("active");
      }

      // Add the "active" class to the button that corresponds to the current tab
      const button = document.querySelector(`.tablinks[onclick="openCity(event, '${jsonData.title}')"]`);
      if (button) {
        button.classList.add("active");
      }

      console.log("Tab modification complete!")
    });
</script>
</body>
</html>
